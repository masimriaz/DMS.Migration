@model DMS.Migration.Web.Models.DiscoveryIndexViewModel
@using DMS.Migration.Domain.Enums
@{
    ViewData["Title"] = "Discovery Runs";
}

<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">
                    <i class="fas fa-search-plus mr-2"></i>Discovery Runs
                </h1>
            </div>
            <div class="col-sm-6">
                <a href="@Url.Action("New")" class="btn btn-primary float-right">
                    <i class="fas fa-plus mr-1"></i> New Discovery
                </a>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show">
                <button type="button" class="close" data-dismiss="alert">&times;</button>
                <i class="fas fa-check-circle mr-2"></i>@TempData["SuccessMessage"]
            </div>
        }

        <!-- Filters -->
        <div class="card">
            <div class="card-body">
                <form method="get" class="form-inline">
                    <label class="mr-2">Filter by Status:</label>
                    <select name="status" class="form-control mr-2">
                        <option value="">All Statuses</option>
                        <option value="@((int)DiscoveryStatus.Queued)"
                            selected="@(Model.FilterStatus == DiscoveryStatus.Queued)">
                            Queued</option>
                        <option value="@((int)DiscoveryStatus.Running)"
                            selected="@(Model.FilterStatus == DiscoveryStatus.Running)">
                            Running</option>
                        <option value="@((int)DiscoveryStatus.Completed)"
                            selected="@(Model.FilterStatus == DiscoveryStatus.Completed)">
                            Completed</option>
                        <option value="@((int)DiscoveryStatus.Failed)"
                            selected="@(Model.FilterStatus == DiscoveryStatus.Failed)">
                            Failed</option>
                    </select>
                    <button type="submit" class="btn btn-secondary">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </form>
            </div>
        </div>

        <!-- Discovery Runs List -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Discovery Runs</h3>
            </div>
            <div class="card-body p-0">
                @if (!Model.Runs.Any())
                {
                    <div class="p-4 text-center text-muted">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No discovery runs found. <a href="@Url.Action("New")">Create your first discovery run</a></p>
                    </div>
                }
                else
                {
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Sites</th>
                                <th>Libraries</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var run in Model.Runs)
                            {
                                <tr>
                                    <td>
                                        <a href="@Url.Action("Details", new { id = run.Id })">
                                            <strong>@run.Name</strong>
                                        </a>
                                    </td>
                                    <td>@run.SourceConnection.Name</td>
                                    <td>
                                        @switch (run.Status)
                                        {
                                            case DiscoveryStatus.Queued:
                                                <span class="badge badge-secondary">Queued</span>
                                                break;
                                            case DiscoveryStatus.Running:
                                                <span class="badge badge-info">
                                                    <i class="fas fa-spinner fa-spin"></i> Running
                                                </span>
                                                break;
                                            case DiscoveryStatus.Completed:
                                                <span class="badge badge-success">Completed</span>
                                                break;
                                            case DiscoveryStatus.Failed:
                                                <span class="badge badge-danger">Failed</span>
                                                break;
                                            case DiscoveryStatus.Cancelled:
                                                <span class="badge badge-warning">Cancelled</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar @(run.Status == DiscoveryStatus.Failed ? "bg-danger" : "")"
                                                role="progressbar" style="width: @run.ProgressPercentage%"
                                                aria-valuenow="@run.ProgressPercentage" aria-valuemin="0" aria-valuemax="100">
                                                @run.ProgressPercentage%
                                            </div>
                                        </div>
                                        @if (!string.IsNullOrEmpty(run.CurrentStep))
                                        {
                                            <small class="text-muted">@run.CurrentStep</small>
                                        }
                                    </td>
                                    <td>@run.TotalSitesScanned</td>
                                    <td>@run.TotalListsScanned</td>
                                    <td>@run.CreatedAt.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td>
                                        <a href="@Url.Action("Details", new { id = run.Id })" class="btn btn-sm btn-primary"
                                            title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>

    </div>
</section>

@section Scripts {
    <script>
        // Auto-refresh for running jobs
        $(document).ready(function () {
            var hasRunningJobs = @(Model.Runs.Any(r => r.Status == DiscoveryStatus.Running || r.Status == DiscoveryStatus.Queued) ? "true" : "false");

            if (hasRunningJobs) {
                setTimeout(function () {
                    location.reload();
                }, 10000); // Refresh every 10 seconds
            }
        });
    </script>
}